# SnowFlake

SnowFlake 软件包是 RT-Thread 基于开源 SnowFlake 算法而制作的一款实用软件包。

## 雪花算法功能特点

- 整形数字，随时间单调递增（不一定连续），长度更短;

- 集合了两种雪花计方式，传统雪花算法和优化的雪花算法（雪花漂移）；

- 优化的雪花算法（雪花漂移），它生成的 ID 更短、速度更快；

- 雪花漂移支持时间回拨处理，比如服务器时间回拨1秒，本算法能自动适应生成临界时间的唯一 ID。

## 如何处理时间回拨

- 当发生系统时间回拨时，算法采用过去时序的预留序数生成新的 ID。

- 回拨生成的 ID 序号，默认靠前，也可以调整为靠后。

- 允许时间回拨至本算法预设基数（参数可调）。

## ID 组成说明

 * 本算法生成的 ID 由 3 部分组成（沿用雪花算法定义）：相对基础时间的时间差 + WorkerId + 序列数 

 * 第1部分，时间差，是生成 ID 时的系统时间减去 BaseTime 的总时间差（毫秒单位）。

 * 第2部分，WorkerId，是区分不同机器或不同应用的唯一ID，最大值由 WorkerIdBitLength（默认 6）限定。

 * 第3部分，序列数，是每毫秒下的序列数，由参数中的 SeqBitLength（默认 6）限定。

## ID 示例

本算法生成的 ID ，是整数（占用空间最多 8 字节），以下是基于默认配置生成的 ID： 

```
 269137030549573
 269137030549574
 269137030549575
```

## 参数设置

***WorkerIdBitLength***，机器码位长，决定 WorkerId 的最大值，**默认值 6**，取值范围 [1, 19]，实际上有些语言采用 无符号 ushort (uint16)  类型接收该参数，所以最大值是16，如果是采用 有符号 short (int16)，则最大值为15。

**WorkerId**，机器码，**最重要参数**，无默认值，必须 **全局唯一**，必须 **程序设定**，缺省条件（WorkerIdBitLength取默认值）时最大值63，理论最大值 2^WorkerIdBitLength-1（不同实现语言可能会限定在 65535 或 32767，原理同 WorkerIdBitLength 规则）。不同机器或不同应用实例 **不能相同**，你可通过应用程序配置该值，也可通过调用外部服务获取值。

**特别提示**：如果一台服务器部署多个独立服务，需要为每个服务指定不同的 WorkerId。

***SeqBitLength***，序列数位长，**默认值6**，取值范围 [3, 21]（建议不小于4），决定每毫秒基础生成的 ID 个数。如果每秒请求数不超过 5W，保持默认值 6 即可；如果超过 5W，不超过 50W，建议赋值 10 或更大，以此类推。规则要求：WorkerIdBitLength + SeqBitLength 不超过 22。

***MinSeqNumber***，最小序列数，默认值 5，取值范围 [5, MaxSeqNumber]，每毫秒的前 5 个序列数对应编号 0-4 是保留位，其中 1-4 是时间回拨相应预留位，0 是手工新值预留位。

***MaxSeqNumber***，最大序列数，设置范围 [MinSeqNumber, 2^SeqBitLength-1]，默认值 0，真实最大序列数取最大值（2^SeqBitLength-1），不为 0 时，取其为真实最大序列数，一般无需设置，除非多机共享 WorkerId 分段生成 ID（此时还要正确设置最小序列数）。

***BaseTime***，基础时间（也称：基点时间、原点时间、纪元时间），有默认值（2020年），是毫秒时间戳（是整数，.NET是DatetTime类型），作用是：用生成ID时的系统时间与基础时间的差值（毫秒数）作为生成 ID 的时间戳。基础时间一般无需设置，如果觉得默认值太老，你可以重新设置，不过要注意，这个值以后最好不变。

## 常规集成

- 用单例模式调用。本算法采用单线程生成ID，多方调用会被互斥。在同一应用实例内，调用者使用多线程（或并行）方式调用本算法，不会增加 ID 产出速度。

- 指定唯一的 WorkerId。必须由外部系统确保 WorkerId 的全局唯一性，并赋值给本算法入口参数。

- 单机多实例部署时使用不同 WorkerId。并非所有实现都支持跨进程的并发唯一，保险起见，在同一主机上部署多应用实例时，请确保各 WorkerId 唯一。

- 认真理解 IdGeneratorOptions 的定义，这对集成和使用本算法有帮助。

- 使用雪花漂移算法。虽然代码里包含了传统雪花算法的定义，并且你可以在入口处指定（Method=2）来启用传统算法，但仍建议你使用雪花漂移算法（Method=1，默认的），毕竟它具有更好的伸缩力和更高的性能。

- 应用域内配置策略相同。当系统运行一段时间后，项目需要从程序指定 WorkerId 转到自动注册 WorkerId 时，请确保同一应用域内所有在用实例采用一致的配置策略，这不仅仅针对 WorkerId，也包含其他配置参数。

- 管理好服务器时间。雪花算法依赖系统时间，不要手工大幅度回调操作系统时间。如果一定要调整，切记：确保服务再次启动时的系统时间大于最后一次关闭时的时间。（注：世界级或网络级的时间同步或回拨，引起的系统时间小幅度变化，对本算法没影响）

## 配置变更

配置变更是指系统运行一段时间后，再调整运行参数（IdGeneratorOptions 对象属性），请注意：

- 1.首要原则是：BaseTime **只能更旧**（距现在更远），让生成的 ID 值较历史最大值更大，确保没有时间重叠区，不产生重复 ID。[**不推荐** 在系统运行之后调整 BaseTime]

- 2.任何时候增加 WorkerIdBitLength 或 SeqBitLength，都是允许的，但应慎用 “减小”操作，因为这可能导致在未来某天生成的 ID 与旧配置时相同。[允许在系统运行之后 **增加** 任何一个 xxxBitLength 值]

- 3.如果必须减小 WorkerIdBitLength 或 SeqBitLength 其中的一项，一定要满足条件：新的两个 xxxBitLength 之和要大于旧值之和。[**不推荐** 在运行之后缩小任何一个 BitLength 值]

- 4.上述 3 条规则，并未在本算法内做逻辑控制，使用者应在确认新配置符合要求后，再实施配置变更。
